# models/vulnerability.py - Модель уязвимостей - ИСПРАВЛЕННАЯ версия
from dataclasses import dataclass
from datetime import datetime
from typing import Optional
import ipaddress
import logging

logger = logging.getLogger(__name__)

@dataclass
class Vulnerability:
    """Модель уязвимости"""
    id: Optional[int] = None
    ip_address: str = ""
    template_method: Optional[str] = None
    connection_method: Optional[str] = None
    severity_level: Optional[str] = None
    url: Optional[str] = None
    additional_info: Optional[str] = None
    source_host_id: Optional[int] = None
    timestamp: Optional[datetime] = None
    
    def __post_init__(self):
        """Валидация данных после инициализации"""
        # Валидация IP адреса (упрощенная)
        if self.ip_address and self.ip_address != "unknown":
            try:
                import ipaddress
                ipaddress.ip_address(self.ip_address)
            except ValueError:
                # Если не IP-адрес, проверяем что это не пустая строка
                if not self.ip_address.strip():
                    self.ip_address = "unknown"
        
        # Валидация уровня критичности
        valid_levels = ['info', 'low', 'medium', 'high', 'critical']
        if self.severity_level and self.severity_level not in valid_levels:
            logger.warning(f"Неизвестный уровень критичности: {self.severity_level}")
            self.severity_level = 'info'
        
        # Установка временной метки по умолчанию
        if not self.timestamp:
            self.timestamp = datetime.utcnow()
    
    @classmethod
    def from_dict(cls, data: dict):
        """Создание объекта из словаря"""
        return cls(
            id=data.get('id'),
            ip_address=str(data.get('ip_address', '')),
            template_method=data.get('template_method'),
            connection_method=data.get('connection_method'),
            severity_level=data.get('severity_level'),
            url=data.get('url'),
            additional_info=data.get('additional_info'),
            source_host_id=data.get('source_host_id'),
            timestamp=data.get('timestamp')
        )
    
    def to_dict(self) -> dict:
        """Преобразование в словарь"""
        return {
            'id': self.id,
            'ip_address': self.ip_address,
            'template_method': self.template_method,
            'connection_method': self.connection_method,
            'severity_level': self.severity_level,
            'url': self.url,
            'additional_info': self.additional_info,
            'source_host_id': self.source_host_id,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None
        }